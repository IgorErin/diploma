% !TeX spellcheck = ru_RU
% !TEX root = vkr.tex

\section{Метрики}

Метрики собираемые рантаймом предполагается использовать в двух направлениях:

\begin{itemize}
    \item Семплирование --- наблюдения поведения внутренних структур рантайма в определенный моменты исполнения задач
    \item Тотальная оценка --- анализ количеств тех или иных операций произведенных за весь период исполнения
\end{itemize}

К первому типу можно отнести глубину глобальной или локальных очередей в определенный момент времени. К последнему --- количество переполнений локальных очередей за все время исполнения. Стоит отметить, что количество переполнений без сомнений имеет смысл фиксировать и во время исполнения, однако, семплирование с легкостью может упустить стремительно меняющиеся значения. Тогда как тотальная сумма не позволяет упускать отдельные операции.

\subsection{Семплирование}

\verb|tokio-metrics|\footnote{\href{https://github.com/tokio-rs/tokio-metrics}{Репозиторий} проекта tokio-metrics (Дата обращения: 4.1.2025)} --- проект, предоставляющий интерфейс для семплирования метрик рантайма и отдельных задач. Далее будет представлен полный перечень метрик доступных из \verb|tokio-metrics| для рантайма, так как применение их для отдельных задач найдено не было. Метрики будут разбиты на группы по аналогии для уменьшения повторений.

Группа предполагает перечисление в следующем порядке: значение представленное в \verb|tokio-metrics| как общее значение для всех воркеров, минимум и максимум среди воркеров, однако, для краткости в списке будет обозначено только первое.

\begin{itemize}
    \item \verb|total_park_count| --- количество парковок потоков воркеров
    \item \verb|mean_poll_duration| --- экспоненциально взвешенная скользящая средняя продолжительность опросов задач
    \item \verb|total_noop_count| --- сколько раз воркер бездействовал между парковками
    \item \verb|total_steal_count| --- количество похищенных задач воркерами
    \item \verb|total_steal_operations| --- сколько раз воркеры похитили задачи
    \item \verb|total_local_schedule_count| --- количество задач отправленных на исполнение из контекста воркера
    \item \verb|total_overflow_count| --- сколько раз воркеры переполнили свои локальные очереди
    \item \verb|total_polls_count| --- количество опросов задач
    \item \verb|total_busy_duration| --- суммарное время исполнения задач
    \item \verb|total_local_queue_depth| --- количество задач помещенных в локальные очереди
\end{itemize}

И остальные:

\begin{itemize}
    \item \verb|workers_count| --- количество воркеров

    \item \verb|poll_time_histogram| --- гистограмма времени опросов задач

    \item \verb|num_remote_schedules| --- количество задач, отправленных на исполнение из вне

    \item \verb|global_queue_depth| --- количество задач находящихся в глобальной очереди
\end{itemize}

\subsection{Тотальные метрики}

\verb|tokio| предоставляет интерфейс для экстракции метрик из инстанса рантайма. Соответственно, для получения необходимо лишь опрашивать предварительно подверженный необходимым условиям инстанс.

Общие метрики для рантайма:

\begin{itemize}
    \item \verb|num_workers| --- количество воркеров
    \item \verb|num_alive_tasks| --- количеств исполняемых рантаймом задач
    \item \verb|global_queue_depth| --- количество задач в глобальной очереди
    \item \verb|num_blocking_threads| --- количество блокирующих потоков
    \item \verb|num_idle_blocking_threads| --- количество простаивающих блокирующих потоков
    \item \verb|spawned_tasks_count| --- количество созданных задач
    \item \verb|remote_schedule_count| --- количество задачи созданных вне контекста воркера
    \item \verb|budget_forced_yield_count| --- количество задач вытесненных рантаймом с исполнения
    \item \verb|blocking_queue_depth| --- количество задач в очереди блокирующего пулла
\end{itemize}

Метрики вычисляемые отдельно для каждого воркера:

\begin{itemize}
    \item \verb|worker_thread_id| --- получения внутреннего идентификатора воркера
    \item \verb|worker_park_count| --- количество парковок потока воркера
    \item \verb|worker_park_unpark_count| --- сумма парковок и распарковок
    \item \verb|worker_noop_count| --- количество бездействий между парковками
    \item \verb|worker_steal_count| --- количество похищенных задач
    \item \verb|worker_steal_operations| --- количество похищений
    \item \verb|worker_poll_count| --- количество опросов задач
    \item \verb|worker_total_busy_duration| --- время исполнения воркером задач
    \item \verb|worker_local_schedule_count| --- количество созданных в контексте воркера задач
    \item \verb|worker_overflow_count| --- количество переполнений локальной очереди
    \item \verb|worker_local_queue_depth| --- количество элементов в локальной очереди
    \item \verb|worker_mean_poll_time| --- экспоненциально взвешенная скользящая средняя продолжительность опросов задач
\end{itemize}

Метрики описывающие время опроса задач в виде гистограмм:

\begin{itemize}
    \item \verb|poll_count_histogram_enabled| --- включен ли сбор гистограмм количества опросов

    \item \verb|poll_time_histogram_num_buckets| --- количество значений гистограммы

    \item \verb|poll_time_histogram_bucket_range| --- значения гистограммы
\end{itemize}

Как было сказано выше, в качестве тотальных метрик интерес представляют исключительно метрики имеющие накопительный характер. К таким можно отнести количество парковок потока воркера (\verb|worker_park_count|) или временные гистограммы опроса задач (\verb|poll_time_histogram_bucket_range|). Метрики диагностирующие состояние структур в определенный момент времени, например, глубину глобальной или локальных очередей, после исполнения бенчмарка имеют не большое значение, ибо должны быть равны нулю. Однако, именно это ``должны быть'' можно и нужно подвергать дополнительной проверке в качестве пред и постусловий.

\subsection{Выделенные метрики}

Для решения поставленных задач были выделены метрики, отражающие взаимодействие воркеров с очередями. То есть метрики, демонстрирующие глубину глобальной очереди (\verb|global_queue_depth|), локальных очередей (\verb|total_local_queue_depth|), количество переполнений (\verb|total_overflow_count|), количество похищений (\verb|total_steal_operations|), количество удаленных спавнов (\verb|num_remote_schedules|).

Для самопроверки были выделены временные гистограммы исполнения задач (\verb|poll_time_histogram_bucket_range|), количества воркеров (\verb|num_workers|), количество исполняемых задач (\verb|num_alive_tasks|) и тому подобные.
